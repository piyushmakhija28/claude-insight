{% extends "base.html" %}
{% block title %}Architecture Health - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-heartbeat me-2 text-danger"></i>Architecture Module Health
                </h2>
                <p class="text-muted mt-1">Health check for all 67 architecture policy modules</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-danger btn-sm" onclick="loadData()">
                    <i class="fas fa-sync-alt me-1"></i>Re-check Health
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="syncModules()">
                    <i class="fas fa-cloud-download-alt me-1"></i>Sync from GitHub
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Health Score Banner -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm" id="healthBanner">
            <div class="card-body text-center py-4">
                <i class="fas fa-spinner fa-spin fa-3x text-muted"></i>
                <p class="mt-2 text-muted">Checking module health...</p>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-cubes stat-icon text-primary"></i>
                <div class="stat-value text-primary" id="totalModules"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Total Modules</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-check-circle stat-icon text-success"></i>
                <div class="stat-value text-success" id="okModules"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">OK / Verified</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-times-circle stat-icon text-danger"></i>
                <div class="stat-value text-danger" id="missingModules"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Missing</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-map-marker-alt stat-icon text-info"></i>
                <div class="stat-value text-info" id="sourceLocation"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Source</div>
            </div>
        </div>
    </div>
</div>

<!-- Module Health by Level -->
<div class="row mb-4" id="levelCards">
    <div class="col-12">
        <div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x text-muted"></i></div>
    </div>
</div>

<script>
async function loadData() {
    try {
        const resp = await fetch('/api/architecture/health');
        const data = await resp.json();

        // Banner
        const banner = document.getElementById('healthBanner');
        const healthPct = data.health_pct || 0;
        const statusColor = healthPct >= 90 ? 'success' : healthPct >= 60 ? 'warning' : 'danger';
        const statusText = healthPct >= 90 ? 'HEALTHY' : healthPct >= 60 ? 'DEGRADED' : 'CRITICAL';
        const statusIcon = healthPct >= 90 ? 'check-circle' : healthPct >= 60 ? 'exclamation-triangle' : 'times-circle';
        banner.innerHTML = `
            <div class="card-body py-4">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                        <div style="font-size:80px;font-weight:bold" class="text-${statusColor}">${healthPct}%</div>
                        <div class="text-muted">Health Score</div>
                    </div>
                    <div class="col-md-6 text-center">
                        <h3 class="text-${statusColor}"><i class="fas fa-${statusIcon} me-2"></i>${statusText}</h3>
                        <p class="text-muted mb-0">Architecture modules health check</p>
                        ${data.sync_needed ? '<div class="alert alert-warning mt-2 mb-0 py-2"><i class="fas fa-exclamation-triangle me-2"></i>Some modules missing. Click "Sync from GitHub" to fix.</div>' : ''}
                    </div>
                    <div class="col-md-3">
                        <div class="progress" style="height:20px">
                            <div class="progress-bar bg-${statusColor}" style="width:${healthPct}%">${healthPct}%</div>
                        </div>
                        <div class="text-muted small mt-2">Location: <code>${data.source_location || 'unknown'}</code></div>
                        ${data.last_policy_executor_check ? `<div class="text-muted small">Last check: ${data.last_policy_executor_check.substring(0,19)}</div>` : ''}
                    </div>
                </div>
            </div>`;

        // Summary cards
        document.getElementById('totalModules').textContent = data.total_modules || 0;
        document.getElementById('okModules').textContent = data.ok || 0;
        document.getElementById('missingModules').textContent = data.missing || 0;
        document.getElementById('sourceLocation').textContent = data.source_location || 'N/A';

        // Level cards
        const container = document.getElementById('levelCards');
        const byLevel = data.by_level || {};

        container.innerHTML = '<div class="col-12"><div class="row">' +
            Object.entries(byLevel).map(([levelKey, levelData]) => {
                const ok = levelData.ok || 0;
                const total = levelData.total || 0;
                const color = ok === total ? 'success' : ok >= total * 0.6 ? 'warning' : 'danger';
                const modules = levelData.modules || [];

                return `<div class="col-md-6 col-lg-3 mb-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-${color}-subtle border-0 pt-3 pb-2">
                            <h6 class="mb-0 text-${color}">${levelData.name}</h6>
                            <small class="text-muted">${ok}/${total} OK</small>
                        </div>
                        <div class="card-body p-0">
                            <div class="progress mx-3 mt-2" style="height:6px">
                                <div class="progress-bar bg-${color}" style="width:${total>0?Math.round(ok/total*100):0}%"></div>
                            </div>
                            <ul class="list-unstyled mt-2 mb-0">
                                ${modules.map(m => `
                                    <li class="px-3 py-1 border-bottom small d-flex justify-content-between align-items-center">
                                        <span class="text-truncate me-2">${m.name}</span>
                                        <span class="badge bg-${m.status==='OK'?'success':'danger'}-subtle text-${m.status==='OK'?'success':'danger'} flex-shrink-0">${m.status}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>`;
            }).join('') + '</div></div>';

    } catch (e) {
        document.getElementById('levelCards').innerHTML =
            '<div class="col-12"><div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading health data: ' + e.message + '</div></div>';
    }
}

async function syncModules() {
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Syncing...';
    try {
        const resp = await fetch('/api/architecture/sync', { method: 'POST' });
        const data = await resp.json();
        alert(data.message || 'Sync initiated. Check logs for details.');
    } catch (e) {
        alert('Sync not available. Run hook-downloader.py manually from claude-code-ide.');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-cloud-download-alt me-1"></i>Sync from GitHub';
        loadData();
    }
}

loadData();
setInterval(loadData, 30000);
</script>
{% endblock %}
