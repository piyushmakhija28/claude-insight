{% extends "base.html" %}

{% block title %}Two-Factor Authentication - Claude Insight{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="fas fa-shield-alt text-primary"></i> Two-Factor Authentication
            </h1>
            <p class="text-muted mb-0">Add an extra layer of security to your account</p>
        </div>
        <div>
            <span class="badge bg-success" id="2faStatus">
                <i class="fas fa-check-circle"></i> Not Configured
            </span>
        </div>
    </div>

    <!-- Alert Messages -->
    <div id="alertContainer"></div>

    <!-- 2FA Status Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="card-title mb-2">
                                <i class="fas fa-mobile-alt text-primary"></i> Authenticator App
                            </h5>
                            <p class="card-text text-muted mb-0">
                                Use an authenticator app like Google Authenticator, Authy, or Microsoft Authenticator
                                to generate verification codes.
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end mt-3 mt-md-0">
                            <button class="btn btn-primary" id="setup2FABtn" onclick="show2FASetup()">
                                <i class="fas fa-plus-circle"></i> Setup 2FA
                            </button>
                            <button class="btn btn-danger d-none" id="disable2FABtn" onclick="disable2FA()">
                                <i class="fas fa-times-circle"></i> Disable 2FA
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup 2FA Section (Hidden by default) -->
    <div class="row d-none" id="setup2FASection">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="fas fa-qrcode text-primary"></i> Step 1: Scan QR Code
                    </h5>
                </div>
                <div class="card-body text-center">
                    <p class="text-muted mb-3">
                        Scan this QR code with your authenticator app
                    </p>
                    <div id="qrCodeContainer" class="mb-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Generating QR code...</span>
                        </div>
                    </div>
                    <div class="alert alert-info" role="alert">
                        <small>
                            <strong>Can't scan?</strong> Manually enter this secret key:<br>
                            <code id="secretKey" class="user-select-all">Loading...</code>
                            <button class="btn btn-sm btn-link" onclick="copySecretKey()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle text-primary"></i> Step 2: Verify Code
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Enter the 6-digit code from your authenticator app to verify setup
                    </p>
                    <form id="verify2FAForm" onsubmit="verify2FASetup(event)">
                        <div class="mb-3">
                            <label for="verificationCode" class="form-label">Verification Code</label>
                            <input type="text" class="form-control form-control-lg text-center"
                                   id="verificationCode" maxlength="6" pattern="[0-9]{6}"
                                   placeholder="000000" required autocomplete="off">
                        </div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-check"></i> Verify & Enable 2FA
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Codes Section -->
    <div class="row d-none" id="backupCodesSection">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="fas fa-key text-warning"></i> Backup Recovery Codes
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Important:</strong> Save these backup codes in a secure location.
                        Each code can only be used once to access your account if you lose your authenticator device.
                    </div>
                    <div class="row" id="backupCodesContainer">
                        <!-- Backup codes will be inserted here -->
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="downloadBackupCodes()">
                            <i class="fas fa-download"></i> Download Codes
                        </button>
                        <button class="btn btn-outline-secondary" onclick="printBackupCodes()">
                            <i class="fas fa-print"></i> Print Codes
                        </button>
                        <button class="btn btn-outline-primary" onclick="copyBackupCodes()">
                            <i class="fas fa-copy"></i> Copy All
                        </button>
                        <button class="btn btn-success float-end" onclick="acknowledgeBackupCodes()">
                            <i class="fas fa-check"></i> I've Saved My Codes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2FA Activity Log -->
    <div class="row mt-4 d-none" id="activityLogSection">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="fas fa-history text-info"></i> Recent 2FA Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Action</th>
                                    <th>IP Address</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="activityLogBody">
                                <!-- Activity log will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let secretKey = '';
    let backupCodes = [];

    // Check 2FA status on page load
    document.addEventListener('DOMContentLoaded', function() {
        check2FAStatus();
        load2FAActivity();
    });

    // Check if 2FA is enabled
    function check2FAStatus() {
        fetch('/api/2fa/status')
            .then(response => response.json())
            .then(data => {
                const statusBadge = document.getElementById('2faStatus');
                const setup2FABtn = document.getElementById('setup2FABtn');
                const disable2FABtn = document.getElementById('disable2FABtn');
                const activityLogSection = document.getElementById('activityLogSection');

                if (data.enabled) {
                    statusBadge.className = 'badge bg-success';
                    statusBadge.innerHTML = '<i class="fas fa-check-circle"></i> Enabled';
                    setup2FABtn.classList.add('d-none');
                    disable2FABtn.classList.remove('d-none');
                    activityLogSection.classList.remove('d-none');
                } else {
                    statusBadge.className = 'badge bg-secondary';
                    statusBadge.innerHTML = '<i class="fas fa-times-circle"></i> Not Configured';
                    setup2FABtn.classList.remove('d-none');
                    disable2FABtn.classList.add('d-none');
                    activityLogSection.classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Error checking 2FA status:', error);
            });
    }

    // Show 2FA setup section
    function show2FASetup() {
        const setup2FASection = document.getElementById('setup2FASection');
        setup2FASection.classList.remove('d-none');

        // Generate QR code
        fetch('/api/2fa/setup', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                secretKey = data.secret;
                document.getElementById('secretKey').textContent = secretKey;

                // Display QR code
                const qrCodeContainer = document.getElementById('qrCodeContainer');
                qrCodeContainer.innerHTML = `<img src="${data.qr_code}" alt="QR Code" class="img-fluid" style="max-width: 300px;">`;

                showAlert('success', 'QR code generated successfully. Scan it with your authenticator app.');
            })
            .catch(error => {
                console.error('Error generating QR code:', error);
                showAlert('danger', 'Failed to generate QR code. Please try again.');
            });
    }

    // Verify 2FA setup
    function verify2FASetup(event) {
        event.preventDefault();
        const code = document.getElementById('verificationCode').value;

        fetch('/api/2fa/verify-setup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code, secret: secretKey })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    backupCodes = data.backup_codes;
                    showBackupCodes();
                    showAlert('success', '2FA enabled successfully!');
                    document.getElementById('setup2FASection').classList.add('d-none');
                    check2FAStatus();
                } else {
                    showAlert('danger', 'Invalid verification code. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error verifying 2FA:', error);
                showAlert('danger', 'Verification failed. Please try again.');
            });
    }

    // Show backup codes
    function showBackupCodes() {
        const backupCodesSection = document.getElementById('backupCodesSection');
        const backupCodesContainer = document.getElementById('backupCodesContainer');

        backupCodesSection.classList.remove('d-none');

        let html = '';
        backupCodes.forEach((code, index) => {
            html += `
                <div class="col-md-4 mb-2">
                    <div class="p-2 bg-light rounded text-center">
                        <code class="fs-5">${code}</code>
                    </div>
                </div>
            `;
        });

        backupCodesContainer.innerHTML = html;
    }

    // Copy secret key
    function copySecretKey() {
        navigator.clipboard.writeText(secretKey);
        showAlert('success', 'Secret key copied to clipboard!');
    }

    // Download backup codes
    function downloadBackupCodes() {
        const content = 'Claude Insight - 2FA Backup Recovery Codes\n' +
                       '==========================================\n\n' +
                       'IMPORTANT: Keep these codes in a safe place.\n' +
                       'Each code can only be used once.\n\n' +
                       backupCodes.join('\n');

        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = '2fa-backup-codes.txt';
        a.click();
        URL.revokeObjectURL(url);
    }

    // Print backup codes
    function printBackupCodes() {
        const printWindow = window.open('', '', 'width=600,height=400');
        printWindow.document.write('<html><head><title>2FA Backup Codes</title></head><body>');
        printWindow.document.write('<h2>Claude Insight - 2FA Backup Recovery Codes</h2>');
        printWindow.document.write('<p><strong>IMPORTANT:</strong> Keep these codes in a safe place. Each code can only be used once.</p>');
        printWindow.document.write('<ul>');
        backupCodes.forEach(code => {
            printWindow.document.write(`<li><code style="font-size: 18px;">${code}</code></li>`);
        });
        printWindow.document.write('</ul>');
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    // Copy all backup codes
    function copyBackupCodes() {
        navigator.clipboard.writeText(backupCodes.join('\n'));
        showAlert('success', 'All backup codes copied to clipboard!');
    }

    // Acknowledge backup codes
    function acknowledgeBackupCodes() {
        document.getElementById('backupCodesSection').classList.add('d-none');
        showAlert('success', 'Setup complete! Your account is now protected with 2FA.');
    }

    // Disable 2FA
    function disable2FA() {
        if (!confirm('Are you sure you want to disable Two-Factor Authentication? This will make your account less secure.')) {
            return;
        }

        const code = prompt('Enter a verification code from your authenticator app to confirm:');
        if (!code) return;

        fetch('/api/2fa/disable', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', '2FA has been disabled.');
                    check2FAStatus();
                } else {
                    showAlert('danger', 'Invalid verification code. 2FA not disabled.');
                }
            })
            .catch(error => {
                console.error('Error disabling 2FA:', error);
                showAlert('danger', 'Failed to disable 2FA. Please try again.');
            });
    }

    // Load 2FA activity log
    function load2FAActivity() {
        fetch('/api/2fa/activity')
            .then(response => response.json())
            .then(data => {
                const activityLogBody = document.getElementById('activityLogBody');

                if (data.activities && data.activities.length > 0) {
                    let html = '';
                    data.activities.forEach(activity => {
                        const statusBadge = activity.status === 'success'
                            ? '<span class="badge bg-success">Success</span>'
                            : '<span class="badge bg-danger">Failed</span>';

                        html += `
                            <tr>
                                <td>${new Date(activity.timestamp).toLocaleString()}</td>
                                <td>${activity.action}</td>
                                <td>${activity.ip_address}</td>
                                <td>${statusBadge}</td>
                            </tr>
                        `;
                    });
                    activityLogBody.innerHTML = html;
                } else {
                    activityLogBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No activity yet</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading 2FA activity:', error);
            });
    }

    // Show alert
    function showAlert(type, message) {
        const alertContainer = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alert);

        setTimeout(() => {
            alert.remove();
        }, 5000);
    }
</script>
{% endblock %}
