{% extends "base.html" %}

{% block title %}Automation Dashboard - Claude Insight{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-robot"></i> Complete Automation System</h2>
            <p class="text-muted">Real-time tracking of all CLAUDE.md automation components</p>
        </div>
        <div>
            <button class="btn btn-primary" onclick="refreshAllData()">
                <i class="fas fa-sync-alt"></i> Refresh All
            </button>
        </div>
    </div>

    <!-- Session Start Recommendations -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-play-circle"></i> Session Start Recommendations</h5>
        </div>
        <div class="card-body">
            <div id="sessionStartContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 9th Daemon Status -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-cog"></i> 9th Daemon - Auto-Recommendation</h5>
        </div>
        <div class="card-body">
            <div id="daemon9Content">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <!-- Task Breakdown Stats -->
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-tasks"></i> Task Breakdown Enforcement</h5>
                </div>
                <div class="card-body">
                    <div id="taskBreakdownContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <!-- Task Auto-Tracker Stats -->
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Task Auto-Tracker</h5>
                </div>
                <div class="card-body">
                    <div id="taskTrackerContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Skills & Agents Section -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <!-- Skill Selection Stats -->
            <div class="card h-100">
                <div class="card-header bg-purple text-white">
                    <h5 class="mb-0"><i class="fas fa-puzzle-piece"></i> Skill Selection</h5>
                </div>
                <div class="card-body">
                    <div id="skillsContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <!-- Agent Usage Stats -->
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-users-cog"></i> Agent Invocations</h5>
                </div>
                <div class="card-body">
                    <div id="agentsContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Plan Mode & Optimization Section -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <!-- Plan Mode Suggestions -->
            <div class="card h-100">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-clipboard-list"></i> Plan Mode Suggestions</h5>
                </div>
                <div class="card-body">
                    <div id="planModeContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <!-- Tool Optimization Metrics -->
            <div class="card h-100">
                <div class="card-header bg-teal text-white">
                    <h5 class="mb-0"><i class="fas fa-tachometer-alt"></i> Tool Optimization (15 Strategies)</h5>
                </div>
                <div class="card-body">
                    <div id="optimizationContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Standards Enforcement -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="fas fa-shield-alt"></i> Coding Standards Enforcement</h5>
        </div>
        <div class="card-body">
            <div id="standardsContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-purple {
    background-color: #6f42c1 !important;
}
.bg-teal {
    background-color: #20c997 !important;
}
.metric-card {
    border-left: 4px solid #007bff;
    padding: 15px;
    margin-bottom: 10px;
    background: #f8f9fa;
}
.metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: #007bff;
}
.metric-label {
    font-size: 0.9rem;
    color: #6c757d;
    text-transform: uppercase;
}
.status-badge {
    padding: 5px 10px;
    border-radius: 20px;
    font-weight: bold;
}
.status-running {
    background-color: #28a745;
    color: white;
}
.status-stopped {
    background-color: #dc3545;
    color: white;
}
.status-unknown {
    background-color: #6c757d;
    color: white;
}
</style>

<script>
// Load all automation data
function loadSessionStart() {
    fetch('/api/automation/session-start-recommendations')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderSessionStart(data.data);
            }
        });
}

function loadDaemon9() {
    fetch('/api/automation/daemon-9-status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderDaemon9(data.data);
            }
        });
}

function loadTaskBreakdown() {
    fetch('/api/automation/task-breakdown-stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderTaskBreakdown(data.data);
            }
        });
}

function loadTaskTracker() {
    fetch('/api/automation/task-tracker-stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderTaskTracker(data.data);
            }
        });
}

function loadSkills() {
    fetch('/api/skills/selection-stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderSkills(data.data);
            }
        });
}

function loadAgents() {
    fetch('/api/agents/usage-stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderAgents(data.data);
            }
        });
}

function loadPlanMode() {
    fetch('/api/plan-mode/suggestions')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderPlanMode(data.data);
            }
        });
}

function loadOptimization() {
    fetch('/api/optimization/tool-metrics')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderOptimization(data.data);
            }
        });
}

function loadStandards() {
    fetch('/api/optimization/standards-enforcement')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderStandards(data.data);
            }
        });
}

// Render functions
function renderSessionStart(data) {
    let html = '';
    if (data.available) {
        html = `
            <div class="row">
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value">${data.model_recommendation || 'N/A'}</div>
                        <div class="metric-label">Model Recommended</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value">${data.context_percentage || 0}%</div>
                        <div class="metric-label">Context Usage</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value">${(data.skills_recommended || []).length}</div>
                        <div class="metric-label">Skills Recommended</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value">${(data.agents_recommended || []).length}</div>
                        <div class="metric-label">Agents Recommended</div>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <strong>Context Status:</strong> <span class="badge badge-${data.context_status === 'OK' ? 'success' : 'warning'}">${data.context_status}</span>
            </div>
            ${data.optimizations_needed && data.optimizations_needed.length > 0 ? `
                <div class="mt-2">
                    <strong>Optimizations Needed:</strong>
                    <ul>
                        ${data.optimizations_needed.map(opt => `<li>${opt}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
        `;
    } else {
        html = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> ${data.message || 'No recommendations available'}
            </div>
        `;
    }
    document.getElementById('sessionStartContent').innerHTML = html;
}

function renderDaemon9(data) {
    const statusClass = data.status === 'running' ? 'status-running' : (data.status === 'stopped' ? 'status-stopped' : 'status-unknown');
    const html = `
        <div class="row">
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value"><span class="status-badge ${statusClass}">${data.status.toUpperCase()}</span></div>
                    <div class="metric-label">Status</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.pid || 'N/A'}</div>
                    <div class="metric-label">Process ID</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.recommendations_generated || 0}</div>
                    <div class="metric-label">Recommendations Generated</div>
                </div>
            </div>
        </div>
        <div class="mt-2">
            <small class="text-muted"><strong>Description:</strong> ${data.description}</small><br>
            ${data.last_activity ? `<small class="text-muted"><strong>Last Activity:</strong> ${data.last_activity}</small>` : ''}
        </div>
    `;
    document.getElementById('daemon9Content').innerHTML = html;
}

function renderTaskBreakdown(data) {
    const html = `
        <div class="row">
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.total_analyses || 0}</div>
                    <div class="metric-label">Total Analyses</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.tasks_required || 0}</div>
                    <div class="metric-label">Tasks Required</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.phases_required || 0}</div>
                    <div class="metric-label">Phases Required</div>
                </div>
            </div>
        </div>
        ${data.complexity_distribution && Object.keys(data.complexity_distribution).length > 0 ? `
            <div class="mt-3">
                <h6>Complexity Distribution:</h6>
                <ul>
                    ${Object.entries(data.complexity_distribution).map(([score, count]) => `
                        <li>Score ${score}: ${count} times</li>
                    `).join('')}
                </ul>
            </div>
        ` : ''}
    `;
    document.getElementById('taskBreakdownContent').innerHTML = html;
}

function renderTaskTracker(data) {
    const html = `
        <div class="row">
            <div class="col-md-6">
                <div class="metric-card">
                    <div class="metric-value">${data.total_tasks_tracked || 0}</div>
                    <div class="metric-label">Tasks Tracked</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="metric-card">
                    <div class="metric-value">${data.auto_updates || 0}</div>
                    <div class="metric-label">Auto Updates</div>
                </div>
            </div>
        </div>
        <div class="mt-2">
            <strong>Status:</strong> <span class="badge badge-${data.enabled ? 'success' : 'danger'}">${data.enabled ? 'Enabled' : 'Disabled'}</span>
        </div>
    `;
    document.getElementById('taskTrackerContent').innerHTML = html;
}

function renderSkills(data) {
    const html = `
        <div class="row">
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.total_skill_invocations || 0}</div>
                    <div class="metric-label">Total Invocations</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.auto_selected || 0}</div>
                    <div class="metric-label">Auto-Selected</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.manual_invoked || 0}</div>
                    <div class="metric-label">Manual Invoked</div>
                </div>
            </div>
        </div>
        ${data.top_skills && data.top_skills.length > 0 ? `
            <div class="mt-3">
                <h6>Top Skills:</h6>
                <ol>
                    ${data.top_skills.slice(0, 5).map(skill => `
                        <li><strong>${skill.name}</strong>: ${skill.count} times</li>
                    `).join('')}
                </ol>
            </div>
        ` : ''}
    `;
    document.getElementById('skillsContent').innerHTML = html;
}

function renderAgents(data) {
    const html = `
        <div class="row">
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.total_agent_invocations || 0}</div>
                    <div class="metric-label">Total Invocations</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.parallel_agents || 0}</div>
                    <div class="metric-label">Parallel</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.sequential_agents || 0}</div>
                    <div class="metric-label">Sequential</div>
                </div>
            </div>
        </div>
        ${data.top_agents && data.top_agents.length > 0 ? `
            <div class="mt-3">
                <h6>Top Agents:</h6>
                <ol>
                    ${data.top_agents.slice(0, 5).map(agent => `
                        <li><strong>${agent.type}</strong>: ${agent.count} times</li>
                    `).join('')}
                </ol>
            </div>
        ` : ''}
    `;
    document.getElementById('agentsContent').innerHTML = html;
}

function renderPlanMode(data) {
    const html = `
        <div class="row">
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.total_suggestions || 0}</div>
                    <div class="metric-label">Total Suggestions</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.auto_entered || 0}</div>
                    <div class="metric-label">Auto-Entered</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.user_approved || 0}</div>
                    <div class="metric-label">User Approved</div>
                </div>
            </div>
        </div>
        ${data.avg_complexity ? `
            <div class="mt-2">
                <strong>Average Complexity:</strong> ${data.avg_complexity.toFixed(1)} / 20
            </div>
        ` : ''}
    `;
    document.getElementById('planModeContent').innerHTML = html;
}

function renderOptimization(data) {
    let html = `
        <div class="row">
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.total_optimizations || 0}</div>
                    <div class="metric-label">Total Optimizations</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${(data.total_tokens_saved || 0).toLocaleString()}</div>
                    <div class="metric-label">Tokens Saved</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.estimated_savings_percentage || 0}%</div>
                    <div class="metric-label">Estimated Savings</div>
                </div>
            </div>
        </div>
    `;

    if (data.top_strategies && data.top_strategies.length > 0) {
        html += `
            <div class="mt-3">
                <h6>Top 5 Optimization Strategies:</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Strategy</th>
                                <th>Count</th>
                                <th>Tokens Saved</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.top_strategies.map(strategy => `
                                <tr>
                                    <td>${strategy.description}</td>
                                    <td>${strategy.count}</td>
                                    <td>${strategy.tokens_saved.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    document.getElementById('optimizationContent').innerHTML = html;
}

function renderStandards(data) {
    const html = `
        <div class="row">
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.total_enforcements || 0}</div>
                    <div class="metric-label">Total Enforcements</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.violations_detected || 0}</div>
                    <div class="metric-label">Violations Detected</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value">${data.auto_fixes_applied || 0}</div>
                    <div class="metric-label">Auto-Fixes Applied</div>
                </div>
            </div>
        </div>
        ${data.standards_by_type && Object.keys(data.standards_by_type).length > 0 ? `
            <div class="mt-3">
                <h6>Standards by Type:</h6>
                <ul>
                    ${Object.entries(data.standards_by_type).map(([type, count]) => `
                        <li><strong>${type.replace(/_/g, ' ').toUpperCase()}</strong>: ${count} times</li>
                    `).join('')}
                </ul>
            </div>
        ` : ''}
    `;
    document.getElementById('standardsContent').innerHTML = html;
}

function refreshAllData() {
    loadSessionStart();
    loadDaemon9();
    loadTaskBreakdown();
    loadTaskTracker();
    loadSkills();
    loadAgents();
    loadPlanMode();
    loadOptimization();
    loadStandards();
}

// Load all data on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshAllData();
    // Auto-refresh every 30 seconds
    setInterval(refreshAllData, 30000);
});
</script>
{% endblock %}
