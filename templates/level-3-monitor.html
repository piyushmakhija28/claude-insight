{% extends "base.html" %}
{% block title %}Level 3 Monitor - Execution System - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-cogs me-2 text-success"></i>Level 3: Execution System Monitor
                </h2>
                <p class="text-muted mt-1">Monitor all 12 execution steps and 17 policies in real time</p>
            </div>
            <div class="d-flex gap-2">
                <a href="/level-2-monitor" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>Level 2
                </a>
                <button class="btn btn-outline-success btn-sm" onclick="loadData()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-layer-group stat-icon text-success"></i>
                <div class="stat-value text-success" id="totalSteps">12</div>
                <div class="stat-label">Execution Steps</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-shield-alt stat-icon text-primary"></i>
                <div class="stat-value text-primary" id="totalPolicies"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Policies Active</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-check-double stat-icon text-success"></i>
                <div class="stat-value text-success" id="execPassed"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Steps Passed</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-brain stat-icon text-warning"></i>
                <div class="stat-value text-warning" id="avgComplexity"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Avg Complexity</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-robot stat-icon text-info"></i>
                <div class="stat-value text-info" id="topModel"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Top Model</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-percentage stat-icon text-secondary"></i>
                <div class="stat-value text-secondary" id="compliancePct"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Compliance</div>
            </div>
        </div>
    </div>
</div>

<!-- 12 Steps Flow -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-project-diagram me-2"></i>Execution Steps Status</h5>
            </div>
            <div class="card-body" id="stepsContainer">
                <div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x text-muted"></i></div>
            </div>
        </div>
    </div>
</div>

<!-- Policy Table + Chart -->
<div class="row mb-4">
    <div class="col-md-7">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Level 3 Policy Execution</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Step</th>
                                <th>Policy</th>
                                <th>Runs</th>
                                <th>Pass Rate</th>
                                <th>Avg ms</th>
                            </tr>
                        </thead>
                        <tbody id="policiesBody">
                            <tr><td colspan="5" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-5">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Model Selection Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="modelChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Trend Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Level 3 Compliance Trend (7 Days)</h5>
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
let modelChart = null, trendChart = null;

const STEPS = [
    { num: '3.0', name: 'Prompt Generation', icon: 'fa-pen', step: 'LEVEL_3_STEP_3_0' },
    { num: '3.1', name: 'Task Breakdown', icon: 'fa-tasks', step: 'LEVEL_3_STEP_3_1' },
    { num: '3.2', name: 'Plan Mode', icon: 'fa-map', step: 'LEVEL_3_STEP_3_2' },
    { num: '3.3', name: 'Context Check', icon: 'fa-search', step: 'LEVEL_3_STEP_3_3' },
    { num: '3.4', name: 'Model Selection', icon: 'fa-robot', step: 'LEVEL_3_STEP_3_4' },
    { num: '3.5', name: 'Skill/Agent', icon: 'fa-cog', step: 'LEVEL_3_STEP_3_5' },
    { num: '3.6', name: 'Tool Optimization', icon: 'fa-tools', step: 'LEVEL_3_STEP_3_6' },
    { num: '3.7', name: 'Failure Prevention', icon: 'fa-shield-alt', step: 'LEVEL_3_STEP_3_7' },
    { num: '3.8', name: 'Parallel Analysis', icon: 'fa-code-branch', step: 'LEVEL_3_STEP_3_8' },
    { num: '3.9', name: 'Execute Tasks', icon: 'fa-play', step: 'LEVEL_3_STEP_3_9' },
    { num: '3.10', name: 'Session Save', icon: 'fa-save', step: 'LEVEL_3_STEP_3_10' },
    { num: '3.11', name: 'Git Auto-Commit', icon: 'fa-code-commit', step: 'LEVEL_3_STEP_3_11' },
    { num: '3.12', name: 'Logging', icon: 'fa-file-alt', step: 'LEVEL_3_STEP_3_12' },
];

async function loadData() {
    try {
        const [monResp, trendResp, statsResp] = await Promise.all([
            fetch('/api/level-3/monitor'),
            fetch('/api/level-3/trend'),
            fetch('/api/3level-flow/stats'),
        ]);
        const monData = await monResp.json();
        const trendData = await trendResp.json();
        const statsData = await statsResp.json();

        // Summary cards
        const policies = monData.policies || [];
        const active = policies.filter(p => p.active).length;
        const totalExec = policies.reduce((s, p) => s + p.total_executions, 0);
        const totalPassed = policies.reduce((s, p) => s + p.passed, 0);
        const compliance = totalExec > 0 ? ((totalPassed / totalExec) * 100).toFixed(1) : 0;

        document.getElementById('totalPolicies').textContent = active;
        document.getElementById('execPassed').textContent = totalPassed;
        document.getElementById('avgComplexity').textContent = statsData.avg_complexity || '--';
        document.getElementById('compliancePct').textContent = compliance + '%';

        const models = statsData.model_distribution || {};
        const topModel = Object.entries(models).sort((a, b) => b[1] - a[1])[0];
        document.getElementById('topModel').textContent = topModel ? topModel[0] : '--';

        // Steps flow
        const stepsEl = document.getElementById('stepsContainer');
        const stepMap = {};
        policies.forEach(p => { stepMap[p.step] = p; });

        stepsEl.innerHTML = '<div class="d-flex flex-wrap gap-2">' +
            STEPS.map(s => {
                const policy = stepMap[s.step];
                const active = policy && policy.total_executions > 0;
                const passRate = policy ? policy.pass_rate : 0;
                const color = active ? (passRate >= 80 ? 'success' : passRate >= 50 ? 'warning' : 'danger') : 'secondary';
                return `<div class="card border-${color} text-center p-2" style="min-width:120px;flex:1">
                    <i class="fas ${s.icon} text-${color} mb-1"></i>
                    <div class="small fw-bold">[${s.num}]</div>
                    <div class="small text-muted">${s.name}</div>
                    <div class="badge bg-${color}-subtle text-${color} mt-1">${active ? passRate + '%' : 'No data'}</div>
                </div>`;
            }).join('') + '</div>';

        // Policies table
        const tbody = document.getElementById('policiesBody');
        tbody.innerHTML = policies.length ? policies.map(p => {
            const badge = p.pass_rate >= 80 ? 'success' : p.pass_rate >= 50 ? 'warning text-dark' : 'danger';
            return `<tr>
                <td><code>${p.step.replace('LEVEL_3_STEP_', '')}</code></td>
                <td>${p.name}</td>
                <td>${p.total_executions}</td>
                <td><span class="badge bg-${badge}">${p.pass_rate}%</span></td>
                <td>${p.avg_duration_ms}ms</td>
            </tr>`;
        }).join('') : '<tr><td colspan="5" class="text-center text-muted py-4">No data</td></tr>';

        // Model chart
        const ctx = document.getElementById('modelChart').getContext('2d');
        if (modelChart) modelChart.destroy();
        const modelLabels = Object.keys(models);
        const modelVals = modelLabels.map(k => models[k]);
        modelChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: modelLabels,
                datasets: [{ label: 'Sessions', data: modelVals, backgroundColor: '#6366f1' }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });

        // Trend
        const tctx = document.getElementById('trendChart').getContext('2d');
        if (trendChart) trendChart.destroy();
        trendChart = new Chart(tctx, {
            type: 'line',
            data: {
                labels: trendData.labels || [],
                datasets: [{
                    label: 'Compliance %',
                    data: trendData.compliance_pct || [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16,185,129,0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: { responsive: true, scales: { y: { min: 0, max: 100 } } }
        });

    } catch (e) {
        console.error(e);
    }
}

loadData();
setInterval(loadData, 5000);
</script>
{% endblock %}
