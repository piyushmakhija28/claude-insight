{% extends "base.html" %}
{% block title %}Level 2 Monitor - Standards Enforcement - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-ruler me-2 text-warning"></i>Level 2: Standards Enforcement Monitor
                </h2>
                <p class="text-muted mt-1">Monitor coding standards and rule enforcement across all sessions</p>
            </div>
            <div class="d-flex gap-2">
                <a href="/level-1-monitor" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>Level 1
                </a>
                <button class="btn btn-outline-warning btn-sm" onclick="loadData()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <a href="/level-3-monitor" class="btn btn-outline-secondary btn-sm">
                    Level 3 <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-list-check stat-icon text-warning"></i>
                <div class="stat-value text-warning" id="totalStandards"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Active Standards</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-gavel stat-icon text-primary"></i>
                <div class="stat-value text-primary" id="totalRules"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Total Rules</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-percentage stat-icon text-success"></i>
                <div class="stat-value text-success" id="compliancePct"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Enforcement Rate</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-exclamation-triangle stat-icon text-danger"></i>
                <div class="stat-value text-danger" id="violations"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Standards Missed</div>
            </div>
        </div>
    </div>
</div>

<!-- Standards List -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Standards Coverage</h5>
            </div>
            <div class="card-body" id="standardsList">
                <div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x text-muted"></i></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Execution History</h5>
            </div>
            <div class="card-body">
                <canvas id="pieChart" height="220"></canvas>
                <div id="executionStats" class="mt-3 text-center text-muted small"></div>
            </div>
        </div>
    </div>
</div>

<!-- Compliance Trend -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Standards Enforcement Trend (7 Days)</h5>
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
let trendChart = null, pieChart = null;

const STANDARDS_LIST = [
    'Project Structure', 'Configuration Management', 'Secrets Handling',
    'Response Formatting', 'Service Layer', 'Entity Design',
    'Controller Design', 'Constants & Enums', 'Utilities',
    'Error Handling', 'API Design', 'Database Standards',
    'Documentation', 'Kubernetes', 'Docker/Jenkins'
];

async function loadData() {
    try {
        const resp = await fetch('/api/level-2/monitor');
        const data = await resp.json();

        // Summary
        document.getElementById('totalStandards').textContent = data.standards_count || 14;
        document.getElementById('totalRules').textContent = data.rules_count || 156;
        document.getElementById('compliancePct').textContent = (data.compliance_pct || 0) + '%';
        document.getElementById('violations').textContent = data.executions_missed || 0;

        // Standards list
        const container = document.getElementById('standardsList');
        const execTotal = data.total_executions || 0;
        const execPassed = data.passed || 0;
        container.innerHTML = STANDARDS_LIST.map((std, i) => {
            const active = execTotal > 0;
            return `<div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <span><i class="fas fa-${active ? 'check-circle text-success' : 'circle text-muted'} me-2"></i>${std}</span>
                <span class="badge bg-${active ? 'success' : 'secondary'}-subtle text-${active ? 'success' : 'secondary'}">${active ? 'Enforced' : 'No data'}</span>
            </div>`;
        }).join('');

        // Pie chart
        const ctx = document.getElementById('pieChart').getContext('2d');
        if (pieChart) pieChart.destroy();
        pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Enforced', 'Skipped'],
                datasets: [{
                    data: [execPassed, execTotal - execPassed],
                    backgroundColor: ['#10b981', '#ef4444'],
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });

        document.getElementById('executionStats').textContent =
            `${execTotal} total executions in last 7 days`;

    } catch (e) {
        console.error(e);
    }
    loadTrend();
}

async function loadTrend() {
    try {
        const resp = await fetch('/api/level-2/trend');
        const data = await resp.json();
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (trendChart) trendChart.destroy();
        trendChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels || [],
                datasets: [{
                    label: 'Compliance %',
                    data: data.compliance_pct || [],
                    backgroundColor: 'rgba(245,158,11,0.7)',
                    borderColor: '#f59e0b',
                    borderWidth: 1,
                }]
            },
            options: {
                responsive: true,
                scales: { y: { min: 0, max: 100 } },
            }
        });
    } catch (e) {}
}

loadData();
setInterval(loadData, 5000);
</script>
{% endblock %}
