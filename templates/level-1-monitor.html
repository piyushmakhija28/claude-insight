{% extends "base.html" %}
{% block title %}Level 1 Monitor - Sync System - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-sync-alt me-2 text-primary"></i>Level 1: Sync System Monitor
                </h2>
                <p class="text-muted mt-1">Real-time monitoring of all Level 1 Sync System policies</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="loadData()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <a href="/level-2-monitor" class="btn btn-outline-secondary btn-sm">
                    Level 2 <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4" id="summaryCards">
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-file-alt stat-icon text-primary"></i>
                <div class="stat-value text-primary" id="totalPolicies"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Level 1 Policies</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-check-circle stat-icon text-success"></i>
                <div class="stat-value text-success" id="activePolicies"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Active (ran in 7d)</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-percentage stat-icon text-info"></i>
                <div class="stat-value text-info" id="compliancePct"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Compliance Rate</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-clock stat-icon text-warning"></i>
                <div class="stat-value text-warning" id="lastRun"><i class="fas fa-spinner fa-spin"></i></div>
                <div class="stat-label">Last Execution</div>
            </div>
        </div>
    </div>
</div>

<!-- Level 1 Policies Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Level 1 Policy Status</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="policiesTable">
                        <thead class="table-light">
                            <tr>
                                <th>Policy Name</th>
                                <th>Component</th>
                                <th>Executions (7d)</th>
                                <th>Pass Rate</th>
                                <th>Avg Duration</th>
                                <th>Last Run</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="policiesBody">
                            <tr><td colspan="7" class="text-center py-4"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Compliance Trend Chart -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Level 1 Compliance Trend (7 Days)</h5>
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Level 1 Policies</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled" id="policyList">
                    <li class="mb-2"><i class="fas fa-circle me-2 text-primary" style="font-size:8px"></i>Session Memory Policy</li>
                    <li class="mb-2"><i class="fas fa-circle me-2 text-primary" style="font-size:8px"></i>Session Chaining Policy</li>
                    <li class="mb-2"><i class="fas fa-circle me-2 text-primary" style="font-size:8px"></i>Session Pruning Policy</li>
                    <li class="mb-2"><i class="fas fa-circle me-2 text-primary" style="font-size:8px"></i>Context Management</li>
                    <li class="mb-2"><i class="fas fa-circle me-2 text-primary" style="font-size:8px"></i>User Preferences Policy</li>
                    <li class="mb-2"><i class="fas fa-circle me-2 text-primary" style="font-size:8px"></i>Cross-Project Patterns</li>
                </ul>
                <hr>
                <p class="text-muted small">Level 1 policies manage session continuity, context tracking, and user preference learning across sessions.</p>
            </div>
        </div>
    </div>
</div>

<script>
let trendChart = null;

async function loadData() {
    await Promise.all([loadPolicies(), loadTrend()]);
}

async function loadPolicies() {
    try {
        const resp = await fetch('/api/level-1/monitor');
        const data = await resp.json();

        // Update summary cards
        const policies = data.policies || [];
        const active = policies.filter(p => p.active).length;
        const totalExec = policies.reduce((s, p) => s + p.total_executions, 0);
        const totalPassed = policies.reduce((s, p) => s + p.passed, 0);
        const compliance = totalExec > 0 ? ((totalPassed / totalExec) * 100).toFixed(1) : 0;
        const lastRun = policies.map(p => p.last_run).filter(Boolean).sort().reverse()[0];

        document.getElementById('totalPolicies').textContent = policies.length;
        document.getElementById('activePolicies').textContent = active;
        document.getElementById('compliancePct').textContent = compliance + '%';
        document.getElementById('lastRun').textContent = lastRun ? lastRun.substring(11, 19) : 'N/A';

        // Update table
        const tbody = document.getElementById('policiesBody');
        if (!policies.length) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No Level 1 policy data found</td></tr>';
            return;
        }

        tbody.innerHTML = policies.map(p => {
            const passRateBadge = p.pass_rate >= 80
                ? `<span class="badge bg-success">${p.pass_rate}%</span>`
                : p.pass_rate >= 50
                    ? `<span class="badge bg-warning text-dark">${p.pass_rate}%</span>`
                    : `<span class="badge bg-danger">${p.pass_rate}%</span>`;
            const statusBadge = p.active
                ? '<span class="badge bg-success-subtle text-success">Active</span>'
                : '<span class="badge bg-secondary-subtle text-secondary">Inactive</span>';
            return `<tr>
                <td><strong>${p.name}</strong></td>
                <td><span class="badge bg-primary-subtle text-primary">${p.component}</span></td>
                <td>${p.total_executions}</td>
                <td>${passRateBadge}</td>
                <td>${p.avg_duration_ms}ms</td>
                <td class="text-muted small">${p.last_run || 'Never'}</td>
                <td>${statusBadge}</td>
            </tr>`;
        }).join('');
    } catch (e) {
        document.getElementById('policiesBody').innerHTML =
            '<tr><td colspan="7" class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle me-2"></i>Error loading data</td></tr>';
    }
}

async function loadTrend() {
    try {
        const resp = await fetch('/api/level-1/trend');
        const data = await resp.json();
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (trendChart) trendChart.destroy();
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels || [],
                datasets: [{
                    label: 'Compliance %',
                    data: data.compliance_pct || [],
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99,102,241,0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                scales: { y: { min: 0, max: 100 } },
                plugins: { legend: { display: false } }
            }
        });
    } catch (e) {}
}

// Auto-refresh every 5 seconds
loadData();
setInterval(loadData, 5000);
</script>
{% endblock %}
