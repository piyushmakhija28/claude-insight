{% extends "base.html" %}
{% block title %}Performance Profiling - Claude Insight{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-tachometer-alt me-2"></i>Performance Profiling</h2>
            <p class="text-muted">Identify bottlenecks and optimize performance</p>
        </div>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary active" onclick="setTimeRange(24)">24h</button>
            <button class="btn btn-sm btn-outline-primary" onclick="setTimeRange(168)">7d</button>
            <button class="btn btn-sm btn-outline-primary" onclick="setTimeRange(720)">30d</button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <p class="text-muted mb-1 small">Total Operations</p>
                    <h3 class="mb-0" id="totalOps">{{ stats.total_operations|default(0) }}</h3>
                    <small class="text-muted">Last 24 hours</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <p class="text-muted mb-1 small">Avg Response Time</p>
                    <h3 class="mb-0 text-info" id="avgTime">{{ "%.0f"|format(stats.avg_duration_ms|default(0)) }}ms</h3>
                    <small class="text-muted" id="avgTrend">Monitoring...</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <p class="text-muted mb-1 small">Slow Operations</p>
                    <h3 class="mb-0 text-warning" id="slowOps">{{ stats.slow_operations_count|default(0) }}</h3>
                    <small class="text-muted">&gt;2 seconds</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <p class="text-muted mb-1 small">Optimization Rate</p>
                    <h3 class="mb-0" id="optimizationRate" style="color: var(--success-color)">{{ "%.0f"|format(stats.optimization_rate|default(0)) }}%</h3>
                    <small class="text-muted">Using optimizations</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 pt-4 pb-3">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Response Time Trends</h5>
                </div>
                <div class="card-body">
                    <canvas id="trendChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 pt-4 pb-3">
                    <h5 class="mb-0"><i class="fas fa-puzzle-piece me-2"></i>Operations by Tool</h5>
                </div>
                <div class="card-body">
                    <canvas id="toolsChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendations -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 pt-4 pb-3">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>AI Recommendations</h5>
                </div>
                <div class="card-body">
                    <div id="recommendations">
                        {% if recommendations %}
                            {% for rec in recommendations %}
                            <div class="alert alert-{{ 'info' if rec.type == 'optimization' else 'warning' if rec.type == 'warning' else 'success' }} mb-3">
                                <h6>
                                    <i class="fas {{ 'fa-exclamation-circle text-danger' if rec.severity == 'critical' else 'fa-exclamation-triangle text-warning' if rec.severity == 'high' else 'fa-info-circle text-info' }} me-2"></i>
                                    {{ rec.title }}
                                </h6>
                                <p class="mb-2">{{ rec.description }}</p>
                                <strong>Suggestion:</strong> {{ rec.suggestion }}
                                {% if rec.example %}
                                <pre class="mt-2 bg-light p-2 rounded" style="color: var(--text-primary);"><code>{{ rec.example }}</code></pre>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No recommendations at this time. System is performing well!</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Slow Operations Table -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 pt-4 pb-3">
                    <h5 class="mb-0"><i class="fas fa-stopwatch me-2"></i>Slow Operations</h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Tool</th>
                                <th>Target</th>
                                <th>Duration</th>
                                <th>Time</th>
                                <th>Optimization</th>
                            </tr>
                        </thead>
                        <tbody id="slowOperationsTable">
                            {% if slow_operations %}
                                {% for op in slow_operations %}
                                <tr>
                                    <td><span class="badge bg-primary">{{ op.tool }}</span></td>
                                    <td><code>{{ op.target[:60] }}{{ '...' if op.target|length > 60 else '' }}</code></td>
                                    <td class="text-danger">{{ "%.0f"|format(op.duration_ms) }}ms</td>
                                    <td>{{ op.timestamp[:19] }}</td>
                                    <td>
                                        {% if op.optimization_applied %}
                                        <span class="badge bg-success">Optimized</span>
                                        {% else %}
                                        <span class="badge bg-danger">Not Optimized</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="5" class="text-center text-muted">No slow operations detected</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentTimeRange = 24;
let trendChartInstance = null;
let toolsChartInstance = null;

document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadRecommendations();
    loadSlowOperations();

    // Auto-refresh every 30 seconds
    setInterval(() => {
        loadStats();
        loadRecommendations();
        loadSlowOperations();
    }, 30000);
});

function loadStats() {
    fetch('/api/performance/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.data;

                // Update KPI cards
                document.getElementById('totalOps').textContent = stats.total_operations.toLocaleString();
                document.getElementById('avgTime').textContent = Math.round(stats.avg_duration_ms) + 'ms';
                document.getElementById('slowOps').textContent = stats.slow_operations_count;
                document.getElementById('optimizationRate').textContent = Math.round(stats.optimization_rate) + '%';

                // Update charts
                updateCharts(stats);
            }
        })
        .catch(error => console.error('Error loading stats:', error));
}

function loadRecommendations() {
    fetch('/api/performance/recommendations')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderRecommendations(data.data);
            }
        })
        .catch(error => console.error('Error loading recommendations:', error));
}

function loadSlowOperations() {
    fetch('/api/performance/slow-operations?limit=20')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderSlowOperations(data.data);
            }
        })
        .catch(error => console.error('Error loading slow operations:', error));
}

function renderRecommendations(recommendations) {
    const container = document.getElementById('recommendations');
    if (recommendations.length === 0) {
        container.innerHTML = '<p class="text-muted">No recommendations at this time. System is performing well!</p>';
        return;
    }

    const html = recommendations.map(rec => {
        const iconClass = rec.severity === 'critical' ? 'fa-exclamation-circle text-danger' :
                         rec.severity === 'high' ? 'fa-exclamation-triangle text-warning' :
                         'fa-info-circle text-info';

        const alertType = rec.type === 'optimization' ? 'info' :
                         rec.type === 'warning' ? 'warning' : 'success';

        return `
            <div class="alert alert-${alertType} mb-3">
                <h6><i class="fas ${iconClass} me-2"></i>${rec.title}</h6>
                <p class="mb-2">${rec.description}</p>
                <strong>Suggestion:</strong> ${rec.suggestion}
                ${rec.example ? `<pre class="mt-2 bg-light p-2 rounded" style="color: var(--text-primary);"><code>${rec.example}</code></pre>` : ''}
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

function renderSlowOperations(operations) {
    const tbody = document.getElementById('slowOperationsTable');

    if (operations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No slow operations detected</td></tr>';
        return;
    }

    const html = operations.map(op => {
        const badge = op.optimization_applied ?
            '<span class="badge bg-success">Optimized</span>' :
            '<span class="badge bg-danger">Not Optimized</span>';

        const target = op.target.length > 60 ? op.target.substring(0, 60) + '...' : op.target;
        const timestamp = op.timestamp.substring(0, 19);

        return `
            <tr>
                <td><span class="badge bg-primary">${op.tool}</span></td>
                <td><code>${target}</code></td>
                <td class="text-danger">${Math.round(op.duration_ms)}ms</td>
                <td>${timestamp}</td>
                <td>${badge}</td>
            </tr>
        `;
    }).join('');

    tbody.innerHTML = html;
}

function updateCharts(stats) {
    // Destroy existing charts if they exist
    if (trendChartInstance) {
        trendChartInstance.destroy();
    }
    if (toolsChartInstance) {
        toolsChartInstance.destroy();
    }

    // Response Time Trend Chart (Line)
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    trendChartInstance = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: stats.trend_labels || [],
            datasets: [{
                label: 'Avg Response Time (ms)',
                data: stats.trend_values || [],
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Duration (ms)'
                    }
                }
            }
        }
    });

    // Tools Breakdown Chart (Doughnut)
    const toolsData = stats.tools_breakdown || {};
    const toolsCtx = document.getElementById('toolsChart').getContext('2d');
    toolsChartInstance = new Chart(toolsCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(toolsData),
            datasets: [{
                data: Object.values(toolsData),
                backgroundColor: [
                    'rgb(54, 162, 235)',
                    'rgb(255, 99, 132)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)',
                    'rgb(255, 159, 64)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
}

function setTimeRange(hours) {
    currentTimeRange = hours;
    loadStats();

    // Update button states
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}
</script>
{% endblock %}
