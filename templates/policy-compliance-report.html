{% extends "base.html" %}
{% block title %}Policy Compliance Report - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-file-alt me-2 text-secondary"></i>Policy Compliance Report
                </h2>
                <p class="text-muted mt-1">Generate and export policy enforcement compliance reports</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <select class="form-select form-select-sm" id="hoursFilter" onchange="loadReport()" style="width:160px">
                    <option value="24">Last 24 hours</option>
                    <option value="168" selected>Last 7 days</option>
                    <option value="720">Last 30 days</option>
                </select>
                <button class="btn btn-outline-secondary btn-sm" onclick="exportCSV()">
                    <i class="fas fa-file-csv me-1"></i>Export CSV
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="exportPDF()">
                    <i class="fas fa-file-pdf me-1"></i>Export PDF
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="loadReport()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Executive Summary -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Executive Summary</h5>
            </div>
            <div class="card-body" id="executiveSummary">
                <div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x text-muted"></i></div>
            </div>
        </div>
    </div>
</div>

<!-- By Level Breakdown -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Compliance by Level</h5>
            </div>
            <div class="card-body" id="levelBreakdown">
                <div class="text-center py-4"><i class="fas fa-spinner fa-spin"></i></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Compliance Trend</h5>
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Failing Policies -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm border-warning">
            <div class="card-header bg-warning-subtle border-0 pt-4 pb-3">
                <h5 class="mb-0 text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Policies Needing Attention</h5>
            </div>
            <div class="card-body p-0" id="failingPolicies">
                <div class="text-center py-4"><i class="fas fa-spinner fa-spin"></i></div>
            </div>
        </div>
    </div>
</div>

<!-- Full Policy Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3 d-flex justify-content-between">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>All Policies Compliance</h5>
                <input type="text" class="form-control form-control-sm" id="tableFilter" placeholder="Filter policies..." style="width:200px" oninput="filterTable()">
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="complianceTable">
                        <thead class="table-light">
                            <tr>
                                <th>Policy</th>
                                <th>Level</th>
                                <th>Executions</th>
                                <th>Passed</th>
                                <th>Failed</th>
                                <th>Compliance %</th>
                                <th>Avg Duration</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="complianceBody">
                            <tr><td colspan="8" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let trendChart = null;
let reportData = null;

async function loadReport() {
    const hours = document.getElementById('hoursFilter').value;
    try {
        const resp = await fetch(`/api/policies/compliance/report?hours=${hours}`);
        reportData = await resp.json();
        renderReport(reportData);
    } catch (e) {
        console.error(e);
    }
}

function renderReport(data) {
    const summary = data.summary || {};

    // Executive summary
    const compliancePct = summary.overall_compliance || 0;
    const color = compliancePct >= 90 ? 'success' : compliancePct >= 70 ? 'warning' : 'danger';
    document.getElementById('executiveSummary').innerHTML = `
        <div class="row">
            <div class="col-md-3 text-center">
                <div style="font-size:70px;font-weight:bold" class="text-${color}">${compliancePct}%</div>
                <div class="text-muted">Overall Compliance</div>
            </div>
            <div class="col-md-9">
                <div class="row g-3">
                    <div class="col-sm-3"><div class="p-3 bg-light rounded text-center">
                        <div class="fs-4 fw-bold">${summary.sessions_analyzed || 0}</div><div class="text-muted small">Sessions</div>
                    </div></div>
                    <div class="col-sm-3"><div class="p-3 bg-light rounded text-center">
                        <div class="fs-4 fw-bold">${summary.total_executions || 0}</div><div class="text-muted small">Executions</div>
                    </div></div>
                    <div class="col-sm-3"><div class="p-3 bg-success-subtle rounded text-center">
                        <div class="fs-4 fw-bold text-success">${summary.passing || 0}</div><div class="text-muted small">Passing</div>
                    </div></div>
                    <div class="col-sm-3"><div class="p-3 bg-danger-subtle rounded text-center">
                        <div class="fs-4 fw-bold text-danger">${summary.failing || 0}</div><div class="text-muted small">Failing</div>
                    </div></div>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height:12px">
                        <div class="progress-bar bg-success" style="width:${compliancePct}%"></div>
                        <div class="progress-bar bg-danger" style="width:${100-compliancePct}%"></div>
                    </div>
                    <small class="text-muted">Generated at: ${data.generated_at ? data.generated_at.substring(0,19) : 'now'}</small>
                </div>
            </div>
        </div>`;

    // Level breakdown
    const byLevel = data.by_level || {};
    const levelNames = { 'level_-1': 'Level -1: Auto-Fix', 'level_1': 'Level 1: Sync', 'level_2': 'Level 2: Standards', 'level_3': 'Level 3: Execution' };
    document.getElementById('levelBreakdown').innerHTML = Object.entries(byLevel).map(([key, val]) => {
        const pct = val.compliance_pct || 0;
        const barColor = pct >= 90 ? 'success' : pct >= 70 ? 'warning' : 'danger';
        return `<div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
                <span>${levelNames[key] || key}</span>
                <span class="fw-bold text-${barColor}">${pct}%</span>
            </div>
            <div class="progress" style="height:10px">
                <div class="progress-bar bg-${barColor}" style="width:${pct}%"></div>
            </div>
            <small class="text-muted">${val.passed || 0} passed / ${val.total || 0} total</small>
        </div>`;
    }).join('');

    // Trend chart
    const trend = data.trend || { labels: [], compliance_pct: [] };
    const ctx = document.getElementById('trendChart').getContext('2d');
    if (trendChart) trendChart.destroy();
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: trend.labels,
            datasets: [{ label: 'Compliance %', data: trend.compliance_pct, borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)', fill: true, tension: 0.4 }]
        },
        options: { responsive: true, scales: { y: { min: 0, max: 100 } }, plugins: { legend: { display: false } } }
    });

    // Failing policies
    const failing = data.failing_policies || [];
    document.getElementById('failingPolicies').innerHTML = failing.length ?
        `<div class="table-responsive"><table class="table table-hover mb-0">
            <thead class="table-light"><tr><th>Policy</th><th>Level</th><th>Runs</th><th>Pass Rate</th><th>Action</th></tr></thead>
            <tbody>${failing.map(p => `<tr>
                <td>${p.name}</td>
                <td><span class="badge bg-warning text-dark">Level ${p.level}</span></td>
                <td>${p.total}</td>
                <td><span class="badge bg-danger">${p.pass_rate}%</span></td>
                <td><a href="/policy-detail?policy=${p.step}" class="btn btn-sm btn-outline-primary">View Detail</a></td>
            </tr>`).join('')}</tbody>
        </table></div>` :
        '<div class="text-center text-success py-4"><i class="fas fa-check-circle fa-2x mb-2"></i><br>All policies are compliant!</div>';

    // Full table
    const policies = data.all_policies || [];
    const tbody = document.getElementById('complianceBody');
    tbody.innerHTML = policies.map(p => {
        const pct = p.pass_rate;
        const badge = pct >= 80 ? 'success' : pct >= 50 ? 'warning text-dark' : 'danger';
        const statusBadge = p.compliant ? '<span class="badge bg-success-subtle text-success">Compliant</span>' : '<span class="badge bg-danger-subtle text-danger">Non-compliant</span>';
        return `<tr>
            <td><a href="/policy-detail?policy=${p.step}" class="text-decoration-none">${p.name}</a></td>
            <td><span class="badge bg-secondary">Level ${p.level}</span></td>
            <td>${p.total}</td>
            <td class="text-success">${p.passed}</td>
            <td class="text-danger">${p.failed}</td>
            <td><span class="badge bg-${badge}">${pct}%</span></td>
            <td class="text-muted">${p.avg_duration_ms}ms</td>
            <td>${statusBadge}</td>
        </tr>`;
    }).join('');
}

function filterTable() {
    const filter = document.getElementById('tableFilter').value.toLowerCase();
    const rows = document.querySelectorAll('#complianceBody tr');
    rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(filter) ? '' : 'none';
    });
}

function exportCSV() {
    if (!reportData) { alert('Load report first'); return; }
    const policies = reportData.all_policies || [];
    const headers = ['Policy', 'Level', 'Executions', 'Passed', 'Failed', 'Compliance %', 'Avg Duration ms'];
    const rows = policies.map(p => [p.name, p.level, p.total, p.passed, p.failed, p.pass_rate, p.avg_duration_ms]);
    const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'policy-compliance-report.csv'; a.click();
}

function exportPDF() {
    window.print();
}

loadReport();
</script>
{% endblock %}
