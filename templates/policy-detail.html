{% extends "base.html" %}
{% block title %}Policy Detail - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-1">
                        <li class="breadcrumb-item"><a href="/policies">Policies</a></li>
                        <li class="breadcrumb-item active" id="breadcrumbName">Policy Detail</li>
                    </ol>
                </nav>
                <h2 class="mb-0" id="policyTitle">
                    <i class="fas fa-shield-alt me-2 text-primary"></i><span id="policyName">Loading...</span>
                </h2>
                <p class="text-muted mt-1" id="policyDescription">Individual policy execution tracking</p>
            </div>
            <div class="d-flex gap-2">
                <select class="form-select form-select-sm" id="hoursFilter" onchange="loadData()" style="width:140px">
                    <option value="24">Last 24 hours</option>
                    <option value="168" selected>Last 7 days</option>
                    <option value="720">Last 30 days</option>
                </select>
                <button class="btn btn-outline-primary btn-sm" onclick="loadData()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-play-circle stat-icon text-primary"></i>
                <div class="stat-value text-primary" id="totalExec">--</div>
                <div class="stat-label">Total Executions</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-check-circle stat-icon text-success"></i>
                <div class="stat-value text-success" id="passCount">--</div>
                <div class="stat-label">Passed</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-times-circle stat-icon text-danger"></i>
                <div class="stat-value text-danger" id="failCount">--</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-percentage stat-icon text-info"></i>
                <div class="stat-value text-info" id="passRate">--</div>
                <div class="stat-label">Pass Rate</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-tachometer-alt stat-icon text-warning"></i>
                <div class="stat-value text-warning" id="avgDuration">--</div>
                <div class="stat-label">Avg Duration</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-clock stat-icon text-secondary"></i>
                <div class="stat-value text-secondary" id="lastRun">--</div>
                <div class="stat-label">Last Run</div>
            </div>
        </div>
    </div>
</div>

<!-- Chart + Info -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Execution Timeline (Hourly)</h5>
            </div>
            <div class="card-body">
                <canvas id="timelineChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Policy Info</h5>
            </div>
            <div class="card-body" id="policyInfo">
                <div class="text-center py-4"><i class="fas fa-spinner fa-spin"></i></div>
            </div>
        </div>
    </div>
</div>

<!-- Execution History -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Executions</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Timestamp</th>
                                <th>Session ID</th>
                                <th>Status</th>
                                <th>Duration</th>
                                <th>Decision</th>
                            </tr>
                        </thead>
                        <tbody id="executionHistory">
                            <tr><td colspan="5" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let timelineChart = null;
const policyKey = new URLSearchParams(window.location.search).get('policy') || 'prompt-generation';

async function loadData() {
    const hours = document.getElementById('hoursFilter').value;
    try {
        const resp = await fetch(`/api/policies/${policyKey}/stats?hours=${hours}`);
        const data = await resp.json();

        if (data.error) {
            document.getElementById('policyName').textContent = 'Unknown Policy';
            return;
        }

        // Header
        document.getElementById('policyName').textContent = data.name;
        document.getElementById('breadcrumbName').textContent = data.name;
        document.title = `${data.name} - Claude Insight`;

        // Cards
        document.getElementById('totalExec').textContent = data.total_executions;
        document.getElementById('passCount').textContent = data.passed;
        document.getElementById('failCount').textContent = data.failed;
        document.getElementById('passRate').textContent = data.pass_rate + '%';
        document.getElementById('avgDuration').textContent = data.avg_duration_ms + 'ms';
        document.getElementById('lastRun').textContent = data.last_run ? data.last_run.substring(11, 19) : 'Never';

        // Policy info panel
        const levelLabels = { '-1': 'Level -1 (Auto-Fix)', 1: 'Level 1 (Sync)', 2: 'Level 2 (Standards)', 3: 'Level 3 (Execution)' };
        document.getElementById('policyInfo').innerHTML = `
            <dl class="row mb-0">
                <dt class="col-sm-5">Policy Key</dt>
                <dd class="col-sm-7"><code>${data.policy_key}</code></dd>
                <dt class="col-sm-5">Level</dt>
                <dd class="col-sm-7"><span class="badge bg-primary">${levelLabels[data.level] || 'Level ' + data.level}</span></dd>
                <dt class="col-sm-5">Component</dt>
                <dd class="col-sm-7">${data.component}</dd>
                <dt class="col-sm-5">Step</dt>
                <dd class="col-sm-7"><code>${data.step}</code></dd>
                <dt class="col-sm-5">Status</dt>
                <dd class="col-sm-7"><span class="badge bg-${data.total_executions > 0 ? 'success' : 'secondary'}">${data.total_executions > 0 ? 'Active' : 'No data'}</span></dd>
            </dl>`;

        // Execution history table
        const tbody = document.getElementById('executionHistory');
        const execs = data.recent_executions || [];
        tbody.innerHTML = execs.length ? execs.map(e => {
            const isPassed = e.status === 'PASS';
            return `<tr>
                <td class="text-muted small">${e.timestamp}</td>
                <td><code class="small">${e.session_id.substring(0, 30)}</code></td>
                <td><span class="badge bg-${isPassed ? 'success' : 'danger'}">${e.status}</span></td>
                <td>${e.duration_ms}ms</td>
                <td class="text-muted small text-truncate" style="max-width:200px">${e.decision || '-'}</td>
            </tr>`;
        }).join('') : '<tr><td colspan="5" class="text-center text-muted py-4">No execution history found</td></tr>';

        // Timeline chart
        const tResp = await fetch(`/api/policies/${policyKey}/timeline?hours=${hours}`);
        const tData = await tResp.json();
        const ctx = document.getElementById('timelineChart').getContext('2d');
        if (timelineChart) timelineChart.destroy();
        timelineChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: tData.labels || [],
                datasets: [
                    { label: 'Pass', data: tData.pass_data || [], backgroundColor: '#10b981' },
                    { label: 'Fail', data: tData.fail_data || [], backgroundColor: '#ef4444' },
                ]
            },
            options: {
                responsive: true,
                scales: { x: { stacked: true }, y: { stacked: true } },
                plugins: { legend: { position: 'bottom' } }
            }
        });

    } catch (e) {
        console.error(e);
    }
}

loadData();
</script>
{% endblock %}
